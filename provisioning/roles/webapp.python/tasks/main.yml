- name: Install uv for isucon
  become: yes
  become_user: isucon
  pip:
    name: uv
    extra_args: --user --no-cache-dir
    executable: python3
    state: latest

- name: Install for isucari.python
  become: yes
  become_user: isucon
  args:
    chdir: /home/isucon/isucari/webapp/python
  shell: |
    bash -lc "
    set -eu
    export PATH=\"${HOME}/.local/bin:${PATH}\"
    rm -rf .venv
    UV_PROJECT_ENVIRONMENT=.venv uv sync --no-dev --compile-bytecode
    "

- name: Copy isucari.python unit file
  copy:
    src: etc/systemd/system/isucari.python.service
    dest: /etc/systemd/system/isucari.python.service
    owner: root
    group: root
    mode: 0644
  notify:
    - daemon-reload
